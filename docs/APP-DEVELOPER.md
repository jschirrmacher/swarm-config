# App Developer Guide

Deploy your application on the Docker Swarm server with `git push`.

## Quick Start

1. **Create repository** via Web UI at `https://config.justso.de`
   - Enter name, set port
   - Copy the displayed Git URL

2. **Add remote and deploy:**
   ```bash
   git remote add production <copied-git-url>
   git push production main
   ```

Your app is live at `https://myapp.justso.de`.

## Required Files

```
myapp/
├── Dockerfile           # REQUIRED
├── compose.yaml         # REQUIRED
├── project.json         # Project metadata (auto-generated)
├── .dockerignore        # Recommended
└── src/
```

### compose.yaml

```yaml
services:
  myapp:
    image: myapp:${VERSION:-latest}
    env_file:
      - .env
    volumes:
      - ./data:/app/data
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
    networks:
      - kong-net

networks:
  kong-net:
    external: true
```

### project.json

Project metadata for Kong routing. Auto-generated by the Web UI:

```json
{
  "name": "myapp",
  "owner": "username",
  "port": 3000,
  "createdAt": "2026-01-01T00:00:00.000Z"
}
```

Kong routes are generated automatically from this file. No manual `kong.yaml` needed.

## Environment Variables

### .env on the server

Place your `.env` file at `/var/apps/<owner>/<appname>/.env` (never committed to Git):

```bash
ssh justso.de
nano /var/apps/joachim/myapp/.env
```

Use `.env.example` in your repository as documentation.

### Nuxt3 Apps: NUXT_ Prefix

Nuxt3 runtimeConfig can only be overridden at runtime with `NUXT_`-prefixed variables.

If your `nuxt.config.ts` defines:
```ts
runtimeConfig: {
  myApiKey: process.env.MY_API_KEY,
  public: {
    authServerUrl: process.env.AUTH_SERVER_URL,
  }
}
```

Then your `.env` must use:
```bash
NUXT_MY_API_KEY=secret-key
NUXT_PUBLIC_AUTH_SERVER_URL=https://auth.example.com
```

The `NUXT_` prefix maps to `runtimeConfig` keys:
- `NUXT_MY_API_KEY` → `runtimeConfig.myApiKey`
- `NUXT_PUBLIC_AUTH_SERVER_URL` → `runtimeConfig.public.authServerUrl`

### compose.yaml: env_file statt environment

Use `env_file` to load all variables directly into the container:

```yaml
# ✅ Correct
env_file:
  - .env

# ❌ Avoid: variables are expanded at deploy-time on the host
environment:
  - NUXT_API_KEY=${API_KEY}
```

## Deployment

### What happens on `git push`

1. Code is checked out to a temp directory
2. Docker image built with commit ID as tag
3. Stack deployed via `docker stack deploy`
4. Temp directory cleaned up

### What is NOT deployed

- `.env` files (managed on server)
- `data/` directories (persistent volumes)

## Logs and Debugging

```bash
# Live logs
ssh justso.de 'docker service logs -f myapp_myapp'

# Service status
ssh justso.de 'docker service ps myapp_myapp'

# Check environment variables
ssh justso.de 'docker exec $(docker ps --format "{{.Names}}" | grep myapp) env'

# Shell into container
ssh justso.de 'docker exec -it $(docker ps -q -f name=myapp_myapp) sh'
```

## Troubleshooting

| Problem | Check |
|---------|-------|
| App won't start | `docker service logs myapp_myapp` |
| 401 Unauthorized | Check `NUXT_` prefix in `.env` |
| Name resolution failed | Verify `kong-net` network in compose.yaml |
| SSL missing | Wait ~2 min for Let's Encrypt |
| Not reachable | DNS (`nslookup myapp.justso.de`), firewall (`sudo ufw status`) |
