#!/bin/bash
APPNAME="${PWD##*/}"
REPO_PATH="$PWD"
VERSION=$(git rev-parse --short HEAD)
WORK_DIR="/tmp/build-${VERSION}"

echo "üéØ Git Hook: Post-Receive Deployment"
echo "====================================="
echo "Repository: ${APPNAME}"
echo "Version: ${VERSION}"
echo ""

if ! git clone --depth=1 "file://${REPO_PATH}" "$WORK_DIR" 2>&1; then
  echo "‚ùå Failed to clone repository"
  exit 1
fi

cd "$WORK_DIR" || exit 1

echo "üî® Building Docker image..."
if ! docker build -t "${APPNAME}:${VERSION}" .; then
  cd / && rm -rf "$WORK_DIR"
  echo "‚ùå Build failed"
  exit 1
fi

echo ""
echo "üöÄ Deploying stack to Docker Swarm..."

if [ ! -f "compose.yaml" ]; then
  echo "‚ùå compose.yaml not found"
  cd / && rm -rf "$WORK_DIR"
  exit 1
fi

# Deploy direkt aus dem Temp-Verzeichnis
export VERSION
if docker stack deploy -c compose.yaml "$APPNAME"; then
  echo "‚úÖ Deployment completed successfully"
  cd / && rm -rf "$WORK_DIR"
  exit 0
else
  echo "‚ùå Deployment failed"
  cd / && rm -rf "$WORK_DIR"
  exit 1
fi
