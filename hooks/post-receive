#!/bin/bash
APPNAME="${PWD##*/}"
APPNAME="${APPNAME%.git}"
REPO_PATH="$PWD"
VERSION=$(git rev-parse --short HEAD)
WORK_DIR="/tmp/build-${VERSION}"

echo "üéØ Git Hook: Post-Receive Deployment"
echo "====================================="
echo "Repository: ${APPNAME}"
echo "Version: ${VERSION}"
echo "Checkout to: ${WORK_DIR}"
echo ""

if ! git clone --depth=1 "file://${REPO_PATH}" "$WORK_DIR" 2>&1; then
  echo "‚ùå Failed to clone repository"
  exit 1
fi

cd "$WORK_DIR" || exit 1

# Determine APP_DIR from project.json owner or fall back to flat structure
OWNER=""
if [ -f "project.json" ]; then
  OWNER=$(grep -o '"owner"[[:space:]]*:[[:space:]]*"[^"]*"' project.json | head -1 | sed 's/.*"owner"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/')
fi

if [ -n "$OWNER" ]; then
  APP_DIR="/var/apps/${OWNER}/${APPNAME}"
else
  APP_DIR="/var/apps/${APPNAME}"
fi

echo "üìÅ Workspace: ${APP_DIR}"

echo "üî® Building Docker image..."
if ! docker build -t "${APPNAME}:${VERSION}" .; then
  cd / && rm -rf "$WORK_DIR"
  echo "‚ùå Build failed"
  exit 1
fi

echo ""
echo "üöÄ Deploying stack to Docker Swarm..."

if [ ! -f "compose.yaml" ]; then
  echo "‚ùå compose.yaml not found"
  cd / && rm -rf "$WORK_DIR"
  exit 1
fi

# Copy config files to workspace
mkdir -p "$APP_DIR"
cp compose.yaml "$APP_DIR/compose.yaml"
[ -f project.json ] && cp project.json "$APP_DIR/project.json"

cd "$APP_DIR" || exit 1
export VERSION

if docker stack deploy -c compose.yaml "$APPNAME"; then
  echo "‚úÖ Deployment completed successfully"
  cd / && rm -rf "$WORK_DIR"
  exit 0
else
  echo "‚ùå Deployment failed"
  cd / && rm -rf "$WORK_DIR"
  exit 1
fi
